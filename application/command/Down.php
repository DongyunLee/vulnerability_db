<?php

namespace app\command;

use app\controller\Fetch;
use think\console\Command;
use think\console\Input;
use think\console\input\Argument;
use think\console\Output;

class Down extends Command
{
    protected function configure()
    {
        // 指令配置
        $this->setName('down')
            ->addArgument('url', Argument::REQUIRED, 'xml url')
            ->setDescription('download specify xml');
        // 设置参数
        
    }
    
    /**
     * @param \think\console\Input  $input
     * @param \think\console\Output $output
     *
     * @return int|void|null
     * @throws \Exception
     */
    protected function execute(Input $input, Output $output)
    {
        $id = $input->getArgument('url');
    
        // 指令输出
        $template = "http://www.cnvd.org.cn/shareData/download/";
        $url = $template . $id;
        $file_name = './xml/' . date('Y-m-d', strtotime('this week')) . '_' . date(
                'Y-m-d',
                strtotime('-1 days')
            ) . '.xml';
    
        $date = date('Y-m-d');
        $time = date('H:i:s');
    
        $output->write("[{$time}] {$id}: Download Starting...\n");
        exec("wget {$url} -cqO {$file_name} >> ./runtime/down_log_{$date}.log");
        $output->write("[{$time}] {$id}: Download Finished.\n");
    
        $output->write("[{$time}] {$id}: Import Starting...\n");
        if (Fetch::synDb(file_get_contents($file_name), $file_name)) {
            $output->write("[{$time}] {$id}: Import Success!\n\n");
        } else {
            $output->write(
                "[{$time}] {$id}: Import Fault.\nTo Look up runtime/log/" . date(
                    'Ym/d_'
                ) . "cli.log For More Detail\n\n"
            );
        }
    }
}
